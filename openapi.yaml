openapi: 3.0.3

info:
  title: Gatekeeper API
  description: |
    Gatekeeper is a production-grade, Redis-backed API key management
    and distributed rate-limiting service.

    It provides:

    • Per-API-key rate limiting  
    • Atomic enforcement using Redis Lua  
    • Fail-closed security semantics  
    • Structured JSON logging  
    • Prometheus-compatible metrics  

    Versioning Strategy:
    URI-based versioning (/v1/).

  version: 0.0.0

servers:
  - url: /
    description: Current deployment origin

tags:
  - name: Public
    description: Public rate-limiting endpoints
  - name: Admin
    description: Administrative API key management
  - name: Observability
    description: Health and metrics endpoints

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key

    AdminAuth:
      type: apiKey
      in: header
      name: X-Admin-Secret

  schemas:
    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
              example: RATE_LIMIT_EXCEEDED
            message:
              type: string
              example: Too many requests
            details:
              type: object
              additionalProperties: true

    RateLimitDecision:
      type: object
      required:
        - allowed
      properties:
        allowed:
          type: boolean
          example: true

  headers:
    X-RateLimit-Limit:
      description: Maximum number of requests allowed in the current window
      schema:
        type: integer
        example: 100

    X-RateLimit-Remaining:
      description: Remaining requests in the current window
      schema:
        type: integer
        example: 42

    X-RateLimit-Reset:
      description: Epoch timestamp (seconds) when the rate limit resets
      schema:
        type: integer
        example: 1710000000

    Retry-After:
      description: Seconds to wait before retrying
      schema:
        type: integer
        example: 30

  responses:
    UnauthorizedError:
      description: Authentication failed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

paths:
  /:
    get:
      tags: [Observability]
      summary: API root
      description: Returns service metadata and version.
      responses:
        '200':
          description: Service metadata
          content:
            application/json:
              schema:
                type: object
                properties:
                  name:
                    type: string
                  version:
                    type: string
                  status:
                    type: string

  /health:
    get:
      tags: [Observability]
      summary: Health check
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok

  /metrics:
    get:
      tags: [Observability]
      summary: Prometheus metrics endpoint
      responses:
        '200':
          description: Metrics output
          content:
            text/plain:
              schema:
                type: string

  /v1/limit/check:
    post:
      tags: [Public]
      summary: Check rate limit for API key
      security:
        - ApiKeyAuth: []
      responses:
        '200':
          description: Request allowed
          headers:
            X-RateLimit-Limit:
              $ref: '#/components/headers/X-RateLimit-Limit'
            X-RateLimit-Remaining:
              $ref: '#/components/headers/X-RateLimit-Remaining'
            X-RateLimit-Reset:
              $ref: '#/components/headers/X-RateLimit-Reset'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RateLimitDecision'

        '401':
          $ref: '#/components/responses/UnauthorizedError'

        '429':
          description: Rate limit exceeded
          headers:
            X-RateLimit-Limit:
              $ref: '#/components/headers/X-RateLimit-Limit'
            X-RateLimit-Remaining:
              $ref: '#/components/headers/X-RateLimit-Remaining'
            X-RateLimit-Reset:
              $ref: '#/components/headers/X-RateLimit-Reset'
            Retry-After:
              $ref: '#/components/headers/Retry-After'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

        '503':
          description: Backend rate limiter unavailable (fail-closed)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /admin/api-keys:
    post:
      tags: [Admin]
      summary: Create API key
      security:
        - AdminAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                limit:
                  type: integer
                  example: 100
                window:
                  type: integer
                  example: 60
                burst:
                  type: integer
                  example: 10
      responses:
        '201':
          description: API key created
          content:
            application/json:
              schema:
                type: object
                properties:
                  apiKey:
                    type: string
                  limits:
                    type: object
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /admin/api-keys/{key}/disable:
    post:
      tags: [Admin]
      summary: Disable API key
      security:
        - AdminAuth: []
      parameters:
        - in: path
          name: key
          required: true
          schema:
            type: string
      responses:
        '200':
          description: API key disabled
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: disabled
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          description: API key not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /admin/api-keys/{key}/rotate:
    post:
      tags: [Admin]
      summary: Rotate API key
      security:
        - AdminAuth: []
      parameters:
        - in: path
          name: key
          required: true
          schema:
            type: string
      responses:
        '200':
          description: API key rotated
          content:
            application/json:
              schema:
                type: object
                properties:
                  oldApiKey:
                    type: string
                  newApiKey:
                    type: string
                  limits:
                    type: object
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          description: API key not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
